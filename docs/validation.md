# 视觉刺激验证方案

## 1. 目的与范围

- 量化浏览器与显示设备组合的三项关键指标：频率精度误差 \(|f_{\text{meas}} - f_{\text{cfg}}|\)、抖动（瞬时频率标准差）与帧率稳定性（帧间时间方差）。
- 工具定位于原型、教学与工程评测，用于快速判断实验环境能否满足稳态诱发电位（SSVEP）演示需求，非临床级测量工具。
- 支持在浏览器端完成最小增量的“记录与导出”，其余流程（统计、制图、汇报）由 Python 侧脚本自动化完成。

## 2. 评测矩阵与命名约定

- 条件矩阵：刷新率 \{60, 240\} Hz × 浏览器 \{Chrome, Edge, Firefox\}，必要时可扩展至更多刷新率或设备。
- 单次测量导出的文件命名遵循 `{date}_{browser}_{hz}_{mode}_{runID}.json` 规则，例如 `2025-10-24_chrome_240_full_01.json`。
- 所有原始记录集中在该 JSON 文件内，不再拆分 CSV 或子目录，便于随手上传与归档（截图、备注等附加材料可单独存储）。

## 3. 采集流程

1. 人工切换目标显示器刷新率与对应浏览器版本，记录环境信息。
2. 在应用中点击“加载评测示例并运行”按钮：
   - 在画布上自动放置矩阵布局的多频刺激（建议 8–15 Hz，步长 1 Hz）。
   - 自动进入全屏模式并运行 60 s，确保稳定输出。
   - 运行结束后触发导出日志。
3. 重复覆盖条件矩阵中的所有组合，每个组合至少采集两轮以评估重复性。

## 4. 导出数据格式

```json
{
  "date": "2025-10-24",
  "commit": "git-commit-sha",
  "browser": "chrome 141",
  "os": "Windows 11 24H2",
  "refresh_hz": 120,
  "mode": "fullscreen",
  "resolution": "2560x1440",
  "stims": [
    {
      "stim_id": "grid-08",
      "wave": "square",
      "f_cfg": 8.0,
      "label": "08 Hz"
    }
  ],
  "frames": [
    {
      "frame_index": 0,
      "t_ms": 0.0,
      "dt_ms": 16.7
    }
  ],
  "toggles": [
    {
      "stim_id": "grid-08",
      "t_ms": 0.0,
      "edge": "rise"
    }
  ]
}
```

> 说明：若某些环境元信息无法自动获取，可填 `null`。`frames` 与 `toggles` 字段沿用现有记录逻辑，`stims` 仅保留元信息。导出文件为单一 JSON，便于直接上传到 Python 评测脚本。

## 5. 浏览器端导出实现要点

- 复用现有刺激调度器的帧记录接口，确保时间戳与值的计算方式一致，避免额外漂移。
- 统一在 `useStimulation` hook 中管理测量生命周期：进入全屏、开始记录、倒计时结束后退出全屏与导出。
- 导出流程包含：环境信息采样、数据序列化、触发下载；需兼顾 Edge / Firefox 等浏览器的下载策略，可在触发下载后延迟释放对象引用以提高兼容性。
- 导出完毕需重置测量状态，防止二次运行残留，并在界面上提示用户导出文件名。

## 6. Python 端评测指标定义（`scripts/measure/`）

- **测得频率 \(f_{\text{meas}}\)**：读取 JSON 中 `toggles` 的上升沿序列，计算相邻时间差平均周期并取倒数，可根据波形类型选择 rise→rise 或零交点策略。
- **抖动**：以上述周期序列为基础，使用 1 s 滑动窗口换算瞬时频率并计算标准差，作为该刺激的频率抖动指标。
- **帧率稳定性**：使用 `frames` 中的 `dt_ms`，统计方差、95 分位点以及掉帧比例（`dt_ms > 1.5 * (1000 / refresh_hz)`）。
- **预热剔除**：默认忽略首 2 s 的帧数据，可通过命令行参数调整。
- **可用区间判定**：若 \(|f_{\text{meas}} - f_{\text{cfg}}| < \varepsilon\)（默认 0.2 Hz），判定该刺激在当前条件下为“可用”，用于生成最终报表。

## 7. 产出物

- 数据表：按条件与 `stim_id` 输出 `f_cfg, f_meas, abs_err, jitter_std, dt_var, drop_ratio, usable` 字段，可保存为 `scripts/out/summary.csv`。
- 图表：自动生成
  1. 频率与误差曲线（误差棒显示 ±1 标准差）；
  2. 各浏览器的抖动箱线图；
  3. 帧间时间分布直方图。
- 报告：汇总以上图表与结论，输出 `scripts/out/report.md`，可嵌入团队文档、论文或中期汇报。

## 8. 后续计划

1. **前端实现**：完成“加载评测示例并运行”按钮、日志导出与状态提示。
2. **脚本完善**：在 `scripts/measure/` 中实现指标计算、图表绘制与报告生成。
3. **验收流程**：针对每个条件矩阵组合至少完成两轮采集，运行 `npm run build` 与 Python 评测脚本，确认输出无误。
